<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tài khoản - CineBooking</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .profile-page {
        min-height: calc(100vh - 80px);
        padding: 40px 0;
      }

      .profile-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 0 20px;
      }

      .profile-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: linear-gradient(
          135deg,
          var(--accent-primary),
          var(--accent-secondary)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        box-shadow: 0 10px 40px rgba(56, 189, 248, 0.3);
      }

      .profile-avatar i {
        font-size: 3.5rem;
        color: white;
      }

      .profile-header h1 {
        font-size: 2rem;
        margin-bottom: 8px;
      }

      .profile-header p {
        color: var(--text-muted);
      }

      .profile-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 0;
      }

      .profile-tab {
        padding: 14px 24px;
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition-fast);
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .profile-tab:hover {
        color: var(--text-primary);
      }

      .profile-tab.active {
        color: var(--accent-primary);
      }

      .profile-tab.active::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--accent-primary);
      }

      .profile-content {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-color);
        overflow: hidden;
      }

      .tab-panel {
        display: none;
        padding: 30px;
      }

      .tab-panel.active {
        display: block;
      }

      .profile-form {
        max-width: 600px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .form-group {
        margin-bottom: 24px;
      }

      .form-group label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 10px;
        font-weight: 500;
        color: var(--text-secondary);
      }

      .form-group label i {
        color: var(--accent-primary);
        width: 16px;
      }

      .form-group input {
        width: 100%;
        padding: 14px 16px;
        background: var(--bg-tertiary);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 1rem;
        transition: var(--transition-fast);
      }

      .form-group input:focus {
        border-color: var(--accent-primary);
        outline: none;
        box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
      }

      .form-group input:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .form-group input::placeholder {
        color: var(--text-muted);
      }

      .form-actions {
        display: flex;
        gap: 16px;
        margin-top: 30px;
      }

      .form-actions .btn {
        padding: 14px 28px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .info-card {
        background: var(--bg-tertiary);
        border-radius: var(--radius-md);
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
      }

      .info-card h3 {
        font-size: 1.1rem;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .info-card h3 i {
        color: var(--accent-primary);
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-color);
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        color: var(--text-muted);
      }

      .info-value {
        font-weight: 500;
        color: var(--text-primary);
      }

      .password-section {
        max-width: 500px;
      }

      .password-section .form-group {
        position: relative;
      }

      .toggle-password {
        position: absolute;
        right: 12px;
        top: 42px;
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 8px;
        transition: var(--transition-fast);
      }

      .toggle-password:hover {
        color: var(--accent-primary);
      }

      .alert {
        padding: 16px 20px;
        border-radius: var(--radius-md);
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .alert-success {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid var(--success);
        color: var(--success);
      }

      .alert-error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid var(--danger);
        color: var(--danger);
      }

      .alert-info {
        background: rgba(56, 189, 248, 0.1);
        border: 1px solid var(--info);
        color: var(--info);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: var(--bg-tertiary);
        border-radius: var(--radius-md);
        padding: 24px;
        text-align: center;
        border: 1px solid var(--border-color);
      }

      .stat-card .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        font-size: 1.5rem;
      }

      .stat-card .stat-icon.bookings {
        background: rgba(56, 189, 248, 0.15);
        color: var(--accent-primary);
      }

      .stat-card .stat-icon.tickets {
        background: rgba(16, 185, 129, 0.15);
        color: var(--success);
      }

      .stat-card .stat-icon.spent {
        background: rgba(251, 191, 36, 0.15);
        color: var(--warning);
      }

      .stat-card h3 {
        font-size: 2rem;
        margin-bottom: 8px;
      }

      .stat-card p {
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
          gap: 0;
        }

        .profile-tabs {
          flex-wrap: wrap;
        }

        .profile-tab {
          padding: 12px 16px;
          font-size: 0.9rem;
        }

        .tab-panel {
          padding: 20px;
        }

        .form-actions {
          flex-direction: column;
        }

        .form-actions .btn {
          width: 100%;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="container header-content">
        <a href="/" class="logo">
          <i class="fas fa-film"></i>
          <span>CineBooking</span>
        </a>
        <nav class="nav-menu">
          <a href="/" class="nav-link">Trang chủ</a>
          <a href="/movies.html" class="nav-link">Phim</a>
          <a href="/cinemas.html" class="nav-link">Rạp</a>
        </nav>
        <div class="user-menu" id="userMenu">
          <span class="user-name" id="userName"></span>
          <div class="dropdown">
            <button class="dropdown-toggle">
              <i class="fas fa-user-circle"></i>
              <i class="fas fa-chevron-down"></i>
            </button>
            <div class="dropdown-menu">
              <a href="/profile.html" class="active"
                ><i class="fas fa-user"></i> Tài khoản</a
              >
              <a href="/bookings.html"
                ><i class="fas fa-ticket-alt"></i> Lịch sử đặt vé</a
              >
              <a href="#" onclick="logout()"
                ><i class="fas fa-sign-out-alt"></i> Đăng xuất</a
              >
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Profile Page -->
    <main class="profile-page">
      <div class="profile-container">
        <!-- Profile Header -->
        <div class="profile-header">
          <div class="profile-avatar">
            <i class="fas fa-user"></i>
          </div>
          <h1 id="profileName">Đang tải...</h1>
          <p id="profileEmail">Đang tải...</p>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon bookings">
              <i class="fas fa-ticket-alt"></i>
            </div>
            <h3 id="totalBookings">0</h3>
            <p>Lần đặt vé</p>
          </div>
          <div class="stat-card">
            <div class="stat-icon tickets">
              <i class="fas fa-chair"></i>
            </div>
            <h3 id="totalTickets">0</h3>
            <p>Vé đã mua</p>
          </div>
          <div class="stat-card">
            <div class="stat-icon spent">
              <i class="fas fa-coins"></i>
            </div>
            <h3 id="totalSpent">0đ</h3>
            <p>Tổng chi tiêu</p>
          </div>
        </div>

        <!-- Tabs -->
        <div class="profile-tabs">
          <button class="profile-tab active" data-tab="info">
            <i class="fas fa-user"></i> Thông tin cá nhân
          </button>
          <button class="profile-tab" data-tab="password">
            <i class="fas fa-lock"></i> Đổi mật khẩu
          </button>
        </div>

        <!-- Content -->
        <div class="profile-content">
          <!-- Info Tab -->
          <div class="tab-panel active" id="infoPanel">
            <div id="infoAlert"></div>
            <form id="profileForm" class="profile-form">
              <div class="form-row">
                <div class="form-group">
                  <label><i class="fas fa-user"></i> Tên đăng nhập</label>
                  <input type="text" id="username" disabled />
                </div>
                <div class="form-group">
                  <label><i class="fas fa-envelope"></i> Email</label>
                  <input
                    type="email"
                    id="email"
                    required
                    placeholder="Nhập email"
                  />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label><i class="fas fa-id-card"></i> Họ tên</label>
                  <input type="text" id="fullName" placeholder="Nhập họ tên" />
                </div>
                <div class="form-group">
                  <label><i class="fas fa-phone"></i> Số điện thoại</label>
                  <input
                    type="tel"
                    id="phone"
                    placeholder="Nhập số điện thoại"
                  />
                </div>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i> Lưu thay đổi
                </button>
                <button
                  type="button"
                  class="btn btn-outline"
                  onclick="loadProfile()"
                >
                  <i class="fas fa-undo"></i> Hủy
                </button>
              </div>
            </form>
          </div>

          <!-- Password Tab -->
          <div class="tab-panel" id="passwordPanel">
            <div id="passwordAlert"></div>
            <form id="passwordForm" class="password-section">
              <div class="form-group">
                <label><i class="fas fa-lock"></i> Mật khẩu hiện tại</label>
                <input
                  type="password"
                  id="currentPassword"
                  required
                  placeholder="Nhập mật khẩu hiện tại"
                />
                <button
                  type="button"
                  class="toggle-password"
                  onclick="togglePasswordVisibility('currentPassword')"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div class="form-group">
                <label><i class="fas fa-key"></i> Mật khẩu mới</label>
                <input
                  type="password"
                  id="newPassword"
                  required
                  placeholder="Nhập mật khẩu mới (ít nhất 6 ký tự)"
                  minlength="6"
                />
                <button
                  type="button"
                  class="toggle-password"
                  onclick="togglePasswordVisibility('newPassword')"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div class="form-group">
                <label
                  ><i class="fas fa-check-circle"></i> Xác nhận mật khẩu
                  mới</label
                >
                <input
                  type="password"
                  id="confirmPassword"
                  required
                  placeholder="Nhập lại mật khẩu mới"
                  minlength="6"
                />
                <button
                  type="button"
                  class="toggle-password"
                  onclick="togglePasswordVisibility('confirmPassword')"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-key"></i> Đổi mật khẩu
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <div class="footer-bottom">
          <p>&copy; 2024 CineBooking. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
      // Check login
      document.addEventListener("DOMContentLoaded", () => {
        if (!API.getToken()) {
          window.location.href = "/";
          return;
        }

        updateAuthUI();
        loadProfile();
        loadStats();
        setupTabs();
        setupForms();
      });

      // Load profile data
      async function loadProfile() {
        try {
          const response = await API.get("/auth/profile");
          const user = response.data || response.user || response;

          // Update header
          document.getElementById("profileName").textContent =
            user.full_name || user.username;
          document.getElementById("profileEmail").textContent = user.email;

          // Update form
          document.getElementById("username").value = user.username;
          document.getElementById("email").value = user.email;
          document.getElementById("fullName").value = user.full_name || "";
          document.getElementById("phone").value = user.phone || "";

          // Update local storage
          API.setUser(user);
          updateAuthUI();
        } catch (error) {
          console.error("Error loading profile:", error);
          showAlert("infoAlert", "Không thể tải thông tin tài khoản", "error");
        }
      }

      // Load user stats
      async function loadStats() {
        try {
          const response = await API.get("/bookings/my-bookings");
          const bookings = response.data || response.bookings || [];

          let totalBookings = bookings.length;
          let totalTickets = 0;
          let totalSpent = 0;

          bookings.forEach((booking) => {
            if (booking.payment_status === "paid") {
              totalTickets += booking.ticket_count || 1;
              totalSpent += parseFloat(booking.total_amount) || 0;
            }
          });

          document.getElementById("totalBookings").textContent = totalBookings;
          document.getElementById("totalTickets").textContent = totalTickets;
          document.getElementById("totalSpent").textContent =
            formatCurrency(totalSpent);
        } catch (error) {
          console.error("Error loading stats:", error);
        }
      }

      // Setup tabs
      function setupTabs() {
        const tabs = document.querySelectorAll(".profile-tab");
        tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            // Update active tab
            tabs.forEach((t) => t.classList.remove("active"));
            tab.classList.add("active");

            // Show panel
            document
              .querySelectorAll(".tab-panel")
              .forEach((p) => p.classList.remove("active"));
            document
              .getElementById(tab.dataset.tab + "Panel")
              .classList.add("active");
          });
        });
      }

      // Setup forms
      function setupForms() {
        // Profile form
        document
          .getElementById("profileForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');

            try {
              btn.disabled = true;
              btn.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';

              const data = {
                email: document.getElementById("email").value,
                full_name: document.getElementById("fullName").value,
                phone: document.getElementById("phone").value,
              };

              const response = await API.put("/auth/profile", data);

              if (response.success) {
                showAlert(
                  "infoAlert",
                  "Cập nhật thông tin thành công!",
                  "success"
                );
                loadProfile();
              }
            } catch (error) {
              showAlert("infoAlert", error.message || "Có lỗi xảy ra", "error");
            } finally {
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-save"></i> Lưu thay đổi';
            }
          });

        // Password form
        document
          .getElementById("passwordForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');

            const currentPassword =
              document.getElementById("currentPassword").value;
            const newPassword = document.getElementById("newPassword").value;
            const confirmPassword =
              document.getElementById("confirmPassword").value;

            if (newPassword !== confirmPassword) {
              showAlert("passwordAlert", "Mật khẩu mới không khớp!", "error");
              return;
            }

            if (newPassword.length < 6) {
              showAlert(
                "passwordAlert",
                "Mật khẩu mới phải có ít nhất 6 ký tự!",
                "error"
              );
              return;
            }

            try {
              btn.disabled = true;
              btn.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';

              const response = await API.put("/auth/change-password", {
                currentPassword,
                newPassword,
              });

              if (response.success) {
                showAlert(
                  "passwordAlert",
                  "Đổi mật khẩu thành công!",
                  "success"
                );
                document.getElementById("passwordForm").reset();
              }
            } catch (error) {
              showAlert(
                "passwordAlert",
                error.message || "Có lỗi xảy ra",
                "error"
              );
            } finally {
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-key"></i> Đổi mật khẩu';
            }
          });
      }

      // Show alert
      function showAlert(elementId, message, type) {
        const alertDiv = document.getElementById(elementId);
        alertDiv.innerHTML = `
          <div class="alert alert-${type}">
            <i class="fas fa-${
              type === "success"
                ? "check-circle"
                : type === "error"
                ? "exclamation-circle"
                : "info-circle"
            }"></i>
            ${message}
          </div>
        `;

        // Auto hide after 5 seconds
        setTimeout(() => {
          alertDiv.innerHTML = "";
        }, 5000);
      }

      // Toggle password visibility
      function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const button = input.parentElement.querySelector(".toggle-password i");

        if (input.type === "password") {
          input.type = "text";
          button.classList.remove("fa-eye");
          button.classList.add("fa-eye-slash");
        } else {
          input.type = "password";
          button.classList.remove("fa-eye-slash");
          button.classList.add("fa-eye");
        }
      }

      // Format currency
      function formatCurrency(amount) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(amount || 0);
      }

      // Logout function
      function logout() {
        API.removeToken();
        API.removeUser();
        window.location.href = "/";
      }

      // Update auth UI
      function updateAuthUI() {
        const user = API.getUser();
        if (user) {
          document.getElementById("userName").textContent =
            user.full_name || user.username;
        }
      }
    </script>
  </body>
</html>
